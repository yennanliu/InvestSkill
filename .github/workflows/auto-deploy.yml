name: Auto Deploy

# Triggers after the full test suite passes on main.
# Detects version bumps and publishes a GitHub Release, then records
# the deployment result in DEPLOYMENTS.md.

on:
  workflow_run:
    workflows: ["Test Suite"]
    branches: [main]
    types: [completed]

permissions:
  contents: write
  deployments: write

jobs:
  # â”€â”€ Job 1: detect whether this commit introduces a new version â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  detect-version:
    name: Detect Version Change
    runs-on: ubuntu-latest
    # Only proceed when the upstream test suite actually passed
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    outputs:
      version:         ${{ steps.version.outputs.version }}
      is_new_version:  ${{ steps.version.outputs.is_new_version }}
      commit_sha:      ${{ steps.version.outputs.commit_sha }}
      plugin_version:  ${{ steps.version.outputs.plugin_version }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0   # full history so we can inspect tags

    - name: Detect new version
      id: version
      run: |
        CURRENT=$(jq -r '.metadata.version' .claude-plugin/marketplace.json)
        PLUGIN_VER=$(jq -r '.version' plugins/us-stock-analysis/.claude-plugin/plugin.json)
        SHA=$(git rev-parse --short HEAD)

        echo "version=$CURRENT"       >> $GITHUB_OUTPUT
        echo "plugin_version=$PLUGIN_VER" >> $GITHUB_OUTPUT
        echo "commit_sha=$SHA"         >> $GITHUB_OUTPUT

        if git tag -l "v$CURRENT" | grep -q "v$CURRENT"; then
          echo "is_new_version=false"  >> $GITHUB_OUTPUT
          echo "â„¹ï¸  Version $CURRENT already released â€” skipping deploy."
        else
          echo "is_new_version=true"   >> $GITHUB_OUTPUT
          echo "ğŸ†• New version detected: $CURRENT â€” will deploy."
        fi

  # â”€â”€ Job 2: run validation one final time before publishing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pre-deploy-validation:
    name: Pre-Deploy Validation
    needs: detect-version
    if: needs.detect-version.outputs.is_new_version == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Validate JSON manifests
      run: |
        jq empty .claude-plugin/marketplace.json
        jq empty plugins/us-stock-analysis/.claude-plugin/plugin.json
        echo "âœ… JSON manifests valid"

    - name: Run unit test suite
      run: node scripts/test-skills.js

    - name: Verify skills registry
      run: |
        REGISTERED=$(jq -r '.skills[]' plugins/us-stock-analysis/.claude-plugin/plugin.json)
        ERRORS=0
        for skill in $REGISTERED; do
          if [ ! -d "plugins/us-stock-analysis/skills/$skill" ]; then
            echo "âŒ Registered skill '$skill' has no directory"
            ERRORS=$((ERRORS + 1))
          fi
        done
        if [ "$ERRORS" -gt 0 ]; then
          echo "âŒ Skills registry mismatch â€” aborting deploy"
          exit 1
        fi
        echo "âœ… Skills registry valid"

  # â”€â”€ Job 3: build release artifacts and publish â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: Deploy to Marketplaces
    needs: [detect-version, pre-deploy-validation]
    if: needs.detect-version.outputs.is_new_version == 'true'
    runs-on: ubuntu-latest

    env:
      VERSION: ${{ needs.detect-version.outputs.version }}
      SHA:     ${{ needs.detect-version.outputs.commit_sha }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure git
      run: |
        git config user.name  "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # â”€â”€ 3a. Create release packages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Build release packages
      run: |
        mkdir -p dist

        # Full marketplace tarball
        tar -czf "dist/invest-skill-marketplace-${VERSION}.tar.gz" \
          --exclude='./.git' \
          --exclude='./.github' \
          --exclude='./dist' \
          --exclude='./.claude' \
          --exclude='./node_modules' \
          .

        # Per-plugin tarball
        for plugin_dir in plugins/*/; do
          plugin_name=$(basename "$plugin_dir")
          tar -czf "dist/${plugin_name}-${VERSION}.tar.gz" \
            -C plugins "$plugin_name"
        done

        # Checksums (stay in repo root to avoid cd side-effects)
        sha256sum dist/*.tar.gz > dist/checksums.txt
        echo "ğŸ“¦ Packages:"
        ls -lh dist/

    # â”€â”€ 3b. Extract changelog section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Extract release notes
      id: notes
      run: |
        if [ -f CHANGELOG.md ]; then
          sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | sed '$d' > release_notes.md
          [ -s release_notes.md ] && echo "has_notes=true" >> $GITHUB_OUTPUT \
                                  || echo "has_notes=false" >> $GITHUB_OUTPUT
        else
          echo "has_notes=false" >> $GITHUB_OUTPUT
        fi

    # â”€â”€ 3c. Create git tag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Tag release commit
      run: |
        git tag -a "v${VERSION}" -m "Release v${VERSION}"
        git push origin "v${VERSION}"
        echo "ğŸ·ï¸  Tagged v${VERSION}"

    # â”€â”€ 3d. GitHub Release (Claude Code plugin marketplace) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Publish GitHub Release â€” Claude Code Marketplace
      id: github_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name:  v${{ env.VERSION }}
        name:      "InvestSkill v${{ env.VERSION }}"
        body_path: ${{ steps.notes.outputs.has_notes == 'true' && 'release_notes.md' || '' }}
        generate_release_notes: ${{ steps.notes.outputs.has_notes != 'true' }}
        draft:      false
        prerelease: ${{ contains(env.VERSION, 'alpha') || contains(env.VERSION, 'beta') || contains(env.VERSION, 'rc') }}
        files: |
          dist/*.tar.gz
          dist/checksums.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # â”€â”€ 3e. Record deployment result â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Record deployment
      run: node scripts/record-deploy.js
      env:
        DEPLOY_VERSION:    ${{ env.VERSION }}
        DEPLOY_SHA:        ${{ env.SHA }}
        DEPLOY_TIMESTAMP:  ${{ github.event.workflow_run.updated_at }}
        RELEASE_URL:       ${{ steps.github_release.outputs.url }}
        PLUGIN_VERSION:    ${{ needs.detect-version.outputs.plugin_version }}
        SKILL_COUNT:       ${{ toJSON(18) }}
        WORKFLOW_RUN_URL:  ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

    - name: Commit deployment record
      run: |
        git add DEPLOYMENTS.md
        if git diff --cached --quiet; then
          echo "No changes to DEPLOYMENTS.md"
        else
          git commit -m "chore: record deployment v${VERSION} [skip ci]"
          git push origin main
          echo "ğŸ“ Deployment record committed"
        fi

    # â”€â”€ 3f. Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Deployment summary
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸš€ InvestSkill v${VERSION} deployed successfully!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "  Targets:"
        echo "    âœ… Claude Code  â€” GitHub Release published"
        echo "       Install: /plugin marketplace add yennanliu/InvestSkill"
        echo "       Install: /plugin install us-stock-analysis"
        echo ""
        echo "    âœ… Cursor       â€” .cursor/rules/invest-skill.mdc updated"
        echo "       Install: copy .cursor/rules/invest-skill.mdc to your project"
        echo ""
        echo "    âœ… Gemini CLI   â€” GEMINI.md updated"
        echo "       Use:    reference prompts/ directory in Gemini CLI"
        echo ""
        echo "    âœ… Copilot      â€” .github/copilot-instructions.md updated"
        echo "       Auto-applied when repo is opened in VS Code Copilot"
        echo ""
        echo "  Release: ${{ steps.github_release.outputs.url }}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # â”€â”€ Job 4: record skipped deploy (no version change) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  record-skip:
    name: Record (No Version Change)
    needs: detect-version
    if: needs.detect-version.outputs.is_new_version == 'false'
    runs-on: ubuntu-latest
    steps:
    - name: Log skip
      run: |
        echo "â„¹ï¸  Tests passed. Version ${{ needs.detect-version.outputs.version }} already deployed."
        echo "   No new release created."
